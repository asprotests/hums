// HUMS V2 - Database Schema
// Hormuud University Management System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// Enums
// ===========================================

enum ProgramType {
  CERTIFICATE
  DIPLOMA
  BACHELOR
  MASTER
}

enum StudentStatus {
  ACTIVE
  GRADUATED
  SUSPENDED
  WITHDRAWN
}

enum EnrollmentStatus {
  REGISTERED
  DROPPED
  COMPLETED
  FAILED
}

enum GradeType {
  MIDTERM
  FINAL
  ASSIGNMENT
  QUIZ
  PROJECT
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
}

enum EmployeeStatus {
  ACTIVE
  ON_LEAVE
  TERMINATED
}

enum LeaveTypeEnum {
  ANNUAL
  SICK
  MATERNITY
  PATERNITY
  UNPAID
  COMPASSIONATE
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum PayrollStatus {
  DRAFT
  PROCESSED
  APPROVED
  PAID
}

enum SalaryComponentType {
  ALLOWANCE
  DEDUCTION
}

enum CalculationType {
  FIXED
  PERCENTAGE
}

enum InvoiceStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  MOBILE_MONEY
  EVC_PLUS
  ZAAD
  SAHAL
  CARD
}

enum PaymentTransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum SMSStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
}

enum OTPPurpose {
  LOGIN
  PASSWORD_RESET
  VERIFY_PHONE
  VERIFY_EMAIL
  PAYMENT
}

enum BorrowingStatus {
  ACTIVE
  RETURNED
  OVERDUE
  LOST
}

enum ReservationStatus {
  PENDING
  READY
  FULFILLED
  EXPIRED
  CANCELLED
}

enum LateFeeStatus {
  PENDING
  PAID
  WAIVED
}

enum CopyCondition {
  NEW
  GOOD
  FAIR
  POOR
  DAMAGED
}

enum CopyStatus {
  AVAILABLE
  BORROWED
  RESERVED
  MAINTENANCE
  LOST
  RETIRED
}

enum BookStatus {
  AVAILABLE
  LOW_STOCK
  OUT_OF_STOCK
  DISCONTINUED
}

enum AnnouncementType {
  SYSTEM
  ACADEMIC
  FINANCE
  LIBRARY
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

enum EmployeeAttendanceStatus {
  PRESENT
  ABSENT
  HALF_DAY
  ON_LEAVE
  HOLIDAY
}

enum ExcuseStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AdmissionStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  ENROLLED
}

enum DocumentType {
  ID_CARD
  PASSPORT
  CERTIFICATE
  PHOTO
  TRANSCRIPT
  OTHER
}

enum RoomType {
  CLASSROOM
  LAB
  AUDITORIUM
  SEMINAR_ROOM
}

enum ClassStatus {
  OPEN
  CLOSED
  CANCELLED
}

enum ScheduleType {
  LECTURE
  LAB
  TUTORIAL
}

enum GradeComponentType {
  MIDTERM
  FINAL
  QUIZ
  ASSIGNMENT
  PROJECT
  PARTICIPATION
  LAB
  OTHER
}

enum ExamType {
  MIDTERM
  FINAL
  QUIZ
  MAKEUP
}

enum ExamStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum RegistrationPeriodType {
  REGULAR
  LATE
  DROP_ADD
}

enum HoldType {
  FINANCIAL
  ACADEMIC
  LIBRARY
  DISCIPLINARY
  ADMINISTRATIVE
}

enum MaterialType {
  DOCUMENT
  VIDEO
  LINK
  SLIDES
  SYLLABUS
  ASSIGNMENT
  OTHER
}

enum ScholarshipType {
  MERIT
  NEED_BASED
  ATHLETIC
  FULL
  PARTIAL
  EXTERNAL
}

enum ScholarshipAwardStatus {
  PENDING
  APPROVED
  APPLIED
  REVOKED
}

enum WaiverType {
  SIBLING_DISCOUNT
  STAFF_DEPENDENT
  FINANCIAL_HARDSHIP
  ACADEMIC_EXCELLENCE
  OTHER
}

enum FeeWaiverStatus {
  PENDING
  APPROVED
  REJECTED
  APPLIED
}

enum PaymentPlanStatus {
  ACTIVE
  COMPLETED
  DEFAULTED
  CANCELLED
}

enum InstallmentStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
}

enum RefundReason {
  WITHDRAWAL
  OVERPAYMENT
  COURSE_CANCELLATION
  FEE_ADJUSTMENT
  OTHER
}

enum RefundStatus {
  PENDING
  APPROVED
  PROCESSING
  COMPLETED
  REJECTED
}

enum BudgetStatus {
  DRAFT
  ACTIVE
  CLOSED
}

enum TwoFactorMethod {
  TOTP
  SMS
  EMAIL
}

// ===========================================
// Core Auth & User Management Models
// ===========================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  username      String    @unique
  passwordHash  String    @map("password_hash")
  firstName     String    @map("first_name")
  middleName    String?   @map("middle_name")
  lastName      String    @map("last_name")
  phone         String?
  avatar        String?
  isActive      Boolean   @default(true) @map("is_active")
  is2FAEnabled  Boolean   @default(false) @map("is_2fa_enabled")
  emailVerified Boolean   @default(false) @map("email_verified")
  lastLoginAt   DateTime? @map("last_login_at")

  // Soft delete
  deletedAt DateTime? @map("deleted_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  roles                 UserRole[]
  auditLogs             AuditLog[]
  sessions              Session[]
  student               Student?
  employee              Employee?
  holdsPlaced           Hold[]                 @relation("HoldPlacer")
  holdsReleased         Hold[]                 @relation("HoldReleaser")
  prerequisiteOverrides PrerequisiteOverride[]
  attendanceMarked      StudentAttendance[]    @relation("AttendanceMarker")
  excusesReviewed       AttendanceExcuse[]     @relation("ExcuseReviewer")
  gradesEntered         GradeEntry[]           @relation("GradeEnteredBy")
  gradesModified        GradeEntry[]           @relation("GradeModifiedBy")
  gradesFinalized       Enrollment[]           @relation("GradeFinalizer")
  uploadedMaterials     CourseMaterial[]
  leaveRequestsApproved LeaveRequest[]         @relation("LeaveApprover")
  payrollsApproved      Payroll[]              @relation("PayrollApprover")
  borrowings            Borrowing[]            @relation("BorrowingBorrower")
  borrowingsIssued      Borrowing[]            @relation("BorrowingIssuer")
  borrowingsReceived    Borrowing[]            @relation("BorrowingReceiver")
  borrowingsWaived      Borrowing[]            @relation("BorrowingWaiver")
  reservations          Reservation[]
  libraryCard           LibraryCard?
  notifications         Notification[]

  // Advanced Finance relations
  scholarshipAwards      StudentScholarship[] @relation("ScholarshipAwarder")
  feeWaiversApproved     FeeWaiver[]          @relation("WaiverApprover")
  paymentPlansCreated    PaymentPlan[]        @relation("PaymentPlanCreator")
  refundsApproved        RefundRequest[]      @relation("RefundApprover")
  refundsProcessed       RefundRequest[]      @relation("RefundProcessor")
  budgetExpensesRecorded BudgetExpense[]      @relation("BudgetExpenseRecorder")

  // 2FA and Notification Preferences
  twoFactorAuth          TwoFactorAuth?
  notificationPreference NotificationPreference?

  @@index([email])
  @@index([username])
  @@index([isActive])
  @@map("users")
}

model TwoFactorAuth {
  id          String          @id @default(uuid())
  userId      String          @unique @map("user_id")
  method      TwoFactorMethod @default(TOTP)
  secret      String? // Encrypted TOTP secret
  isEnabled   Boolean         @default(false) @map("is_enabled")
  backupCodes String[]        @map("backup_codes") // Hashed backup codes
  lastUsedAt  DateTime?       @map("last_used_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("two_factor_auth")
}

model NotificationPreference {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")

  // Email preferences
  emailEnabled       Boolean @default(true) @map("email_enabled")
  emailAcademic      Boolean @default(true) @map("email_academic")
  emailFinance       Boolean @default(true) @map("email_finance")
  emailLibrary       Boolean @default(true) @map("email_library")
  emailAnnouncements Boolean @default(true) @map("email_announcements")
  emailSystem        Boolean @default(true) @map("email_system") // Cannot be disabled

  // SMS preferences
  smsEnabled  Boolean @default(false) @map("sms_enabled")
  smsUrgent   Boolean @default(true) @map("sms_urgent")
  smsPayments Boolean @default(true) @map("sms_payments")
  smsOtp      Boolean @default(true) @map("sms_otp") // Cannot be disabled

  // Push preferences
  pushEnabled       Boolean @default(true) @map("push_enabled")
  pushAcademic      Boolean @default(true) @map("push_academic")
  pushFinance       Boolean @default(true) @map("push_finance")
  pushLibrary       Boolean @default(true) @map("push_library")
  pushAnnouncements Boolean @default(true) @map("push_announcements")

  // In-app preferences
  inAppSound   Boolean @default(true) @map("in_app_sound")
  inAppDesktop Boolean @default(true) @map("in_app_desktop")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

model Role {
  id          String  @id @default(uuid())
  name        String  @unique
  displayName String  @map("display_name")
  description String?
  isSystem    Boolean @default(false) @map("is_system")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  users       UserRole[]
  permissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String  @id @default(uuid())
  name        String  @unique
  displayName String  @map("display_name")
  description String?
  resource    String // e.g., 'users', 'students', 'courses'
  action      String // e.g., 'create', 'read', 'update', 'delete'

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  roles RolePermission[]

  @@unique([resource, action])
  @@map("permissions")
}

model UserRole {
  id     String @id @default(uuid())
  userId String @map("user_id")
  roleId String @map("role_id")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  id           String @id @default(uuid())
  roleId       String @map("role_id")
  permissionId String @map("permission_id")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model Session {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  token        String   @unique
  refreshToken String   @unique @map("refresh_token")
  userAgent    String?  @map("user_agent")
  ipAddress    String?  @map("ip_address")
  expiresAt    DateTime @map("expires_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

// ===========================================
// Audit Log
// ===========================================

model AuditLog {
  id         String  @id @default(uuid())
  userId     String? @map("user_id")
  action     String // e.g., 'CREATE', 'UPDATE', 'DELETE', 'LOGIN'
  resource   String // e.g., 'User', 'Student', 'Course'
  resourceId String? @map("resource_id")
  oldValues  Json?   @map("old_values")
  newValues  Json?   @map("new_values")
  ipAddress  String? @map("ip_address")
  userAgent  String? @map("user_agent")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([resource, resourceId])
  @@index([createdAt])
  @@index([action])
  @@map("audit_logs")
}

// ===========================================
// Academic Structure Models
// ===========================================

model Faculty {
  id        String  @id @default(uuid())
  name      String
  nameLocal String? @map("name_local") // Somali name
  code      String  @unique

  // Soft delete
  deletedAt DateTime? @map("deleted_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  departments Department[]
  deanId      String?      @map("dean_id")
  dean        Employee?    @relation("FacultyDean", fields: [deanId], references: [id])

  @@index([code])
  @@map("faculties")
}

model Department {
  id        String  @id @default(uuid())
  name      String
  nameLocal String? @map("name_local")
  code      String  @unique
  facultyId String  @map("faculty_id")

  // Soft delete
  deletedAt DateTime? @map("deleted_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  faculty   Faculty    @relation(fields: [facultyId], references: [id])
  hodId     String?    @map("hod_id") // Head of Department
  hod       Employee?  @relation("DepartmentHOD", fields: [hodId], references: [id])
  programs  Program[]
  courses   Course[]
  employees Employee[] @relation("DepartmentEmployees")
  budgets   Budget[]

  @@index([facultyId])
  @@index([code])
  @@map("departments")
}

model Program {
  id            String      @id @default(uuid())
  name          String
  nameLocal     String?     @map("name_local")
  code          String      @unique
  type          ProgramType
  durationYears Int         @map("duration_years")
  totalCredits  Int         @map("total_credits")
  departmentId  String      @map("department_id")

  // Soft delete
  deletedAt DateTime? @map("deleted_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  department    Department             @relation(fields: [departmentId], references: [id])
  students      Student[]
  curriculum    Curriculum[]
  feeStructures FeeStructure[]
  admissions    AdmissionApplication[]

  @@index([departmentId])
  @@index([code])
  @@index([type])
  @@map("programs")
}

model Course {
  id           String  @id @default(uuid())
  name         String
  nameLocal    String? @map("name_local")
  code         String  @unique
  credits      Int
  description  String?
  departmentId String  @map("department_id")

  // Soft delete
  deletedAt DateTime? @map("deleted_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  department            Department             @relation(fields: [departmentId], references: [id])
  prerequisites         Course[]               @relation("CoursePrerequisites")
  prerequisiteFor       Course[]               @relation("CoursePrerequisites")
  classes               Class[]
  curriculum            Curriculum[]
  prerequisiteOverrides PrerequisiteOverride[]

  @@index([departmentId])
  @@index([code])
  @@map("courses")
}

model Curriculum {
  id         String  @id @default(uuid())
  programId  String  @map("program_id")
  courseId   String  @map("course_id")
  semester   Int // Which semester of the program
  isRequired Boolean @default(true) @map("is_required")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  program Program @relation(fields: [programId], references: [id], onDelete: Cascade)
  course  Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([programId, courseId])
  @@map("curriculum")
}

model AcademicYear {
  id        String   @id @default(uuid())
  name      String   @unique // e.g., "2025-2026"
  startDate DateTime @map("start_date")
  endDate   DateTime @map("end_date")
  isCurrent Boolean  @default(false) @map("is_current")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  semesters    Semester[]
  scholarships Scholarship[]

  @@index([isCurrent])
  @@map("academic_years")
}

model Semester {
  id                String   @id @default(uuid())
  name              String // e.g., "Fall 2025", "Spring 2026"
  academicYearId    String   @map("academic_year_id")
  startDate         DateTime @map("start_date")
  endDate           DateTime @map("end_date")
  registrationStart DateTime @map("registration_start")
  registrationEnd   DateTime @map("registration_end")
  isCurrent         Boolean  @default(false) @map("is_current")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  academicYear        AcademicYear         @relation(fields: [academicYearId], references: [id])
  classes             Class[]
  enrollments         Enrollment[]
  registrationPeriods RegistrationPeriod[]

  @@index([academicYearId])
  @@index([isCurrent])
  @@map("semesters")
}

model Room {
  id         String   @id @default(uuid())
  name       String   @unique // e.g., "Room 101", "Lab A"
  building   String?
  capacity   Int
  roomType   RoomType @default(CLASSROOM) @map("room_type")
  facilities String[] @default([])
  isActive   Boolean  @default(true) @map("is_active")

  // Soft delete
  deletedAt DateTime? @map("deleted_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  classes   Class[]
  schedules Schedule[]
  exams     Exam[]

  @@map("rooms")
}

model Class {
  id           String      @id @default(uuid())
  name         String // e.g., "CS101-A"
  courseId     String      @map("course_id")
  semesterId   String      @map("semester_id")
  lecturerId   String      @map("lecturer_id")
  capacity     Int
  roomId       String?     @map("room_id")
  status       ClassStatus @default(OPEN)
  cancelReason String?     @map("cancel_reason")

  // Soft delete
  deletedAt DateTime? @map("deleted_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  course          Course              @relation(fields: [courseId], references: [id])
  semester        Semester            @relation(fields: [semesterId], references: [id])
  lecturer        Employee            @relation(fields: [lecturerId], references: [id])
  room            Room?               @relation(fields: [roomId], references: [id])
  schedules       Schedule[]
  enrollments     Enrollment[]
  attendances     StudentAttendance[]
  excuses         AttendanceExcuse[]
  gradeComponents GradeComponent[]
  exams           Exam[]
  materials       CourseMaterial[]

  @@index([courseId])
  @@index([semesterId])
  @@index([lecturerId])
  @@index([status])
  @@map("classes")
}

model Schedule {
  id           String       @id @default(uuid())
  classId      String       @map("class_id")
  roomId       String?      @map("room_id")
  dayOfWeek    Int          @map("day_of_week") // 0=Sunday, 1=Monday, etc.
  startTime    String       @map("start_time") // e.g., "08:00"
  endTime      String       @map("end_time") // e.g., "09:30"
  scheduleType ScheduleType @default(LECTURE) @map("schedule_type")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  class Class @relation(fields: [classId], references: [id], onDelete: Cascade)
  room  Room? @relation(fields: [roomId], references: [id])

  @@index([classId])
  @@index([roomId])
  @@index([dayOfWeek])
  @@map("schedules")
}

model CourseMaterial {
  id           String       @id @default(uuid())
  classId      String       @map("class_id")
  title        String
  description  String?
  type         MaterialType
  fileUrl      String?      @map("file_url")
  externalUrl  String?      @map("external_url")
  fileSize     Int?         @map("file_size")
  mimeType     String?      @map("mime_type")
  week         Int?
  orderIndex   Int          @default(0) @map("order_index")
  isPublished  Boolean      @default(false) @map("is_published")
  publishedAt  DateTime?    @map("published_at")
  uploadedById String       @map("uploaded_by_id")

  // Soft delete
  deletedAt DateTime? @map("deleted_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  class      Class @relation(fields: [classId], references: [id], onDelete: Cascade)
  uploadedBy User  @relation(fields: [uploadedById], references: [id])

  @@index([classId])
  @@index([week])
  @@index([isPublished])
  @@map("course_materials")
}

// ===========================================
// Student Models
// ===========================================

model Student {
  id                 String        @id @default(uuid())
  studentId          String        @unique @map("student_id") // e.g., "HU/2025/001"
  userId             String        @unique @map("user_id")
  programId          String        @map("program_id")
  admissionDate      DateTime      @map("admission_date")
  expectedGraduation DateTime?     @map("expected_graduation")
  status             StudentStatus @default(ACTIVE)
  currentSemester    Int           @default(1) @map("current_semester")

  // Personal info
  dateOfBirth DateTime? @map("date_of_birth")
  gender      String?
  nationality String?
  address     String?

  // Emergency contact
  emergencyContact      String? @map("emergency_contact")
  emergencyContactPhone String? @map("emergency_contact_phone")

  // Soft delete
  deletedAt DateTime? @map("deleted_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  program               Program                @relation(fields: [programId], references: [id])
  enrollments           Enrollment[]
  invoices              Invoice[]
  payments              Payment[]
  attendances           StudentAttendance[]
  excuses               AttendanceExcuse[]
  scholarships          StudentScholarship[]
  documents             Document[]
  application           AdmissionApplication?
  holds                 Hold[]
  prerequisiteOverrides PrerequisiteOverride[]
  paymentSessions       PaymentSession[]
  paymentTransactions   PaymentTransaction[]

  // Advanced Finance relations
  feeWaivers     FeeWaiver[]
  paymentPlans   PaymentPlan[]
  refundRequests RefundRequest[]

  @@index([studentId])
  @@index([programId])
  @@index([status])
  @@map("students")
}

model Enrollment {
  id         String           @id @default(uuid())
  studentId  String           @map("student_id")
  classId    String           @map("class_id")
  semesterId String           @map("semester_id")
  status     EnrollmentStatus @default(REGISTERED)

  // Final grade fields
  finalPercentage Decimal?  @map("final_percentage") @db.Decimal(5, 2)
  finalGrade      String?   @map("final_grade")
  gradePoints     Decimal?  @map("grade_points") @db.Decimal(3, 2)
  isFinalized     Boolean   @default(false) @map("is_finalized")
  finalizedAt     DateTime? @map("finalized_at")
  finalizedById   String?   @map("finalized_by_id")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class        Class        @relation(fields: [classId], references: [id])
  semester     Semester     @relation(fields: [semesterId], references: [id])
  grades       Grade[]
  gradeEntries GradeEntry[]
  finalizedBy  User?        @relation("GradeFinalizer", fields: [finalizedById], references: [id])

  @@unique([studentId, classId])
  @@index([studentId])
  @@index([classId])
  @@index([semesterId])
  @@index([status])
  @@map("enrollments")
}

// ===========================================
// Registration & Hold Models
// ===========================================

model RegistrationPeriod {
  id         String                 @id @default(uuid())
  semesterId String                 @map("semester_id")
  type       RegistrationPeriodType
  startDate  DateTime               @map("start_date")
  endDate    DateTime               @map("end_date")
  lateFee    Decimal?               @map("late_fee") @db.Decimal(12, 2)
  isActive   Boolean                @default(true) @map("is_active")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  semester Semester @relation(fields: [semesterId], references: [id])

  @@index([semesterId])
  @@index([type])
  @@index([isActive])
  @@map("registration_periods")
}

model Hold {
  id                 String    @id @default(uuid())
  studentId          String    @map("student_id")
  type               HoldType
  reason             String
  placedById         String    @map("placed_by_id")
  placedAt           DateTime  @default(now()) @map("placed_at")
  releasedAt         DateTime? @map("released_at")
  releasedById       String?   @map("released_by_id")
  blocksRegistration Boolean   @default(true) @map("blocks_registration")
  blocksGrades       Boolean   @default(false) @map("blocks_grades")
  blocksTranscript   Boolean   @default(false) @map("blocks_transcript")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  student    Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  placedBy   User    @relation("HoldPlacer", fields: [placedById], references: [id])
  releasedBy User?   @relation("HoldReleaser", fields: [releasedById], references: [id])

  @@index([studentId])
  @@index([type])
  @@index([placedAt])
  @@map("holds")
}

model PrerequisiteOverride {
  id           String @id @default(uuid())
  studentId    String @map("student_id")
  courseId     String @map("course_id")
  approvedById String @map("approved_by_id")
  reason       String

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  student    Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course     Course  @relation(fields: [courseId], references: [id])
  approvedBy User    @relation(fields: [approvedById], references: [id])

  @@unique([studentId, courseId])
  @@index([studentId])
  @@index([courseId])
  @@map("prerequisite_overrides")
}

model Grade {
  id           String    @id @default(uuid())
  enrollmentId String    @map("enrollment_id")
  type         GradeType
  score        Decimal   @db.Decimal(5, 2)
  maxScore     Decimal   @map("max_score") @db.Decimal(5, 2)
  weight       Decimal   @db.Decimal(5, 2) // Percentage weight
  remarks      String?
  gradedById   String    @map("graded_by_id")
  isFinalized  Boolean   @default(false) @map("is_finalized")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  gradedBy   Employee   @relation(fields: [gradedById], references: [id])

  @@index([enrollmentId])
  @@index([type])
  @@map("grades")
}

// ===========================================
// Grading System Models
// ===========================================

model GradeScale {
  id        String  @id @default(uuid())
  name      String
  isDefault Boolean @default(false) @map("is_default")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  grades GradeDefinition[]

  @@map("grade_scales")
}

model GradeDefinition {
  id            String  @id @default(uuid())
  scaleId       String  @map("scale_id")
  letter        String
  minPercentage Decimal @map("min_percentage") @db.Decimal(5, 2)
  maxPercentage Decimal @map("max_percentage") @db.Decimal(5, 2)
  gradePoints   Decimal @map("grade_points") @db.Decimal(3, 2)
  description   String?

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  scale GradeScale @relation(fields: [scaleId], references: [id], onDelete: Cascade)

  @@index([scaleId])
  @@map("grade_definitions")
}

model GradeComponent {
  id          String             @id @default(uuid())
  classId     String             @map("class_id")
  name        String
  type        GradeComponentType
  weight      Decimal            @db.Decimal(5, 2) // Percentage
  maxScore    Decimal            @map("max_score") @db.Decimal(6, 2)
  dueDate     DateTime?          @map("due_date")
  isPublished Boolean            @default(false) @map("is_published")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  class   Class        @relation(fields: [classId], references: [id], onDelete: Cascade)
  entries GradeEntry[]

  @@index([classId])
  @@map("grade_components")
}

model GradeEntry {
  id           String    @id @default(uuid())
  componentId  String    @map("component_id")
  enrollmentId String    @map("enrollment_id")
  score        Decimal   @db.Decimal(6, 2)
  remarks      String?
  enteredById  String    @map("entered_by_id")
  enteredAt    DateTime  @default(now()) @map("entered_at")
  modifiedById String?   @map("modified_by_id")
  modifiedAt   DateTime? @map("modified_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  component  GradeComponent @relation(fields: [componentId], references: [id], onDelete: Cascade)
  enrollment Enrollment     @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  enteredBy  User           @relation("GradeEnteredBy", fields: [enteredById], references: [id])
  modifiedBy User?          @relation("GradeModifiedBy", fields: [modifiedById], references: [id])

  @@unique([componentId, enrollmentId])
  @@index([componentId])
  @@index([enrollmentId])
  @@map("grade_entries")
}

model Exam {
  id           String     @id @default(uuid())
  classId      String     @map("class_id")
  type         ExamType
  title        String
  date         DateTime   @db.Date
  startTime    String     @map("start_time")
  endTime      String     @map("end_time")
  duration     Int // minutes
  roomId       String     @map("room_id")
  maxScore     Decimal    @map("max_score") @db.Decimal(6, 2)
  instructions String?
  status       ExamStatus @default(SCHEDULED)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  class Class @relation(fields: [classId], references: [id])
  room  Room  @relation(fields: [roomId], references: [id])

  @@index([classId])
  @@index([roomId])
  @@index([date])
  @@index([status])
  @@map("exams")
}

model StudentAttendance {
  id         String           @id @default(uuid())
  studentId  String           @map("student_id")
  classId    String           @map("class_id")
  date       DateTime         @db.Date
  status     AttendanceStatus
  markedById String           @map("marked_by_id")
  markedAt   DateTime         @default(now()) @map("marked_at")
  remarks    String?
  excuseId   String?          @map("excuse_id")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  student  Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class    Class             @relation(fields: [classId], references: [id])
  markedBy User              @relation("AttendanceMarker", fields: [markedById], references: [id])
  excuse   AttendanceExcuse? @relation(fields: [excuseId], references: [id])

  @@unique([studentId, classId, date])
  @@index([studentId])
  @@index([classId])
  @@index([date])
  @@map("student_attendances")
}

model AttendanceExcuse {
  id            String       @id @default(uuid())
  studentId     String       @map("student_id")
  classId       String       @map("class_id")
  date          DateTime     @db.Date
  reason        String
  documentUrl   String?      @map("document_url")
  status        ExcuseStatus @default(PENDING)
  reviewedById  String?      @map("reviewed_by_id")
  reviewedAt    DateTime?    @map("reviewed_at")
  reviewRemarks String?      @map("review_remarks")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  student     Student             @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class       Class               @relation(fields: [classId], references: [id])
  reviewedBy  User?               @relation("ExcuseReviewer", fields: [reviewedById], references: [id])
  attendances StudentAttendance[]

  @@unique([studentId, classId, date])
  @@index([studentId])
  @@index([classId])
  @@index([status])
  @@map("attendance_excuses")
}

model AdmissionApplication {
  id            String          @id @default(uuid())
  applicationNo String          @unique @map("application_no") // Auto-generated
  status        AdmissionStatus @default(PENDING)

  // Personal Information
  firstName      String   @map("first_name")
  middleName     String?  @map("middle_name")
  lastName       String   @map("last_name")
  firstNameLocal String?  @map("first_name_local") // Somali
  lastNameLocal  String?  @map("last_name_local")
  dateOfBirth    DateTime @map("date_of_birth")
  gender         String
  phone          String
  email          String
  address        String?
  city           String?
  district       String?
  nationality    String?  @default("Somali")

  // Emergency Contact
  emergencyContactName     String? @map("emergency_contact_name")
  emergencyContactPhone    String? @map("emergency_contact_phone")
  emergencyContactRelation String? @map("emergency_contact_relation")

  // Academic Information
  previousEducationLevel String  @map("previous_education_level")
  previousSchoolName     String? @map("previous_school_name")
  graduationYear         Int?    @map("graduation_year")
  programId              String  @map("program_id")

  // Review Information
  reviewedById    String?   @map("reviewed_by_id")
  reviewedAt      DateTime? @map("reviewed_at")
  reviewRemarks   String?   @map("review_remarks")
  rejectionReason String?   @map("rejection_reason")

  // Enrollment Info (after approval)
  enrolledAt DateTime? @map("enrolled_at")
  studentId  String?   @unique @map("student_id")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  program   Program    @relation(fields: [programId], references: [id])
  student   Student?   @relation(fields: [studentId], references: [id])
  documents Document[]

  @@index([applicationNo])
  @@index([status])
  @@index([programId])
  @@index([email])
  @@map("admission_applications")
}

model Document {
  id           String       @id @default(uuid())
  type         DocumentType
  fileName     String       @map("file_name")
  originalName String       @map("original_name")
  mimeType     String       @map("mime_type")
  size         Int // File size in bytes
  path         String // Storage path
  url          String? // Public URL if applicable

  // Relations - polymorphic (one of these will be set)
  studentId     String? @map("student_id")
  applicationId String? @map("application_id")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  student     Student?              @relation(fields: [studentId], references: [id], onDelete: Cascade)
  application AdmissionApplication? @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([applicationId])
  @@index([type])
  @@map("documents")
}

// ===========================================
// Employee/HR Models
// ===========================================

model Employee {
  id             String         @id @default(uuid())
  employeeId     String         @unique @map("employee_id") // e.g., "EMP/2025/001"
  userId         String         @unique @map("user_id")
  departmentId   String?        @map("department_id")
  position       String
  employmentType EmploymentType @map("employment_type")
  hireDate       DateTime       @map("hire_date")
  endDate        DateTime?      @map("end_date")
  salary         Decimal        @db.Decimal(12, 2)
  status         EmployeeStatus @default(ACTIVE)

  // Personal info
  dateOfBirth DateTime? @map("date_of_birth")
  gender      String?
  nationality String?
  address     String?

  // Banking info
  bankName     String? @map("bank_name")
  bankAccount  String? @map("bank_account")
  mobileWallet String? @map("mobile_wallet") // For EVC Plus, etc.

  // Soft delete
  deletedAt DateTime? @map("deleted_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user             User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  department       Department?               @relation("DepartmentEmployees", fields: [departmentId], references: [id])
  classes          Class[] // For lecturers
  grades           Grade[] // Grades given
  leaveRequests    LeaveRequest[]
  leaveBalances    LeaveBalance[]
  payrolls         Payroll[]
  attendances      EmployeeAttendance[]
  salaryComponents EmployeeSalaryComponent[]

  // Leadership roles
  facultyDean   Faculty[]    @relation("FacultyDean")
  departmentHOD Department[] @relation("DepartmentHOD")

  @@index([employeeId])
  @@index([departmentId])
  @@index([status])
  @@map("employees")
}

model LeaveTypeConfig {
  id               String        @id @default(uuid())
  name             String        @unique
  nameLocal        String?       @map("name_local")
  type             LeaveTypeEnum
  daysPerYear      Int           @map("days_per_year")
  carryForward     Boolean       @default(false) @map("carry_forward")
  maxCarryDays     Int           @default(0) @map("max_carry_days")
  requiresDocument Boolean       @default(false) @map("requires_document")
  isPaid           Boolean       @default(true) @map("is_paid")
  isActive         Boolean       @default(true) @map("is_active")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  balances LeaveBalance[]
  requests LeaveRequest[]

  @@map("leave_type_configs")
}

model LeaveBalance {
  id             String @id @default(uuid())
  employeeId     String @map("employee_id")
  leaveTypeId    String @map("leave_type_id")
  year           Int
  allocated      Int    @default(0)
  used           Int    @default(0)
  carriedForward Int    @default(0) @map("carried_forward")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  employee  Employee        @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveType LeaveTypeConfig @relation(fields: [leaveTypeId], references: [id])

  @@unique([employeeId, leaveTypeId, year])
  @@index([employeeId])
  @@index([year])
  @@map("leave_balances")
}

model LeaveRequest {
  id              String      @id @default(uuid())
  employeeId      String      @map("employee_id")
  leaveTypeId     String      @map("leave_type_id")
  startDate       DateTime    @map("start_date") @db.Date
  endDate         DateTime    @map("end_date") @db.Date
  totalDays       Int         @map("total_days")
  reason          String
  documentUrl     String?     @map("document_url")
  status          LeaveStatus @default(PENDING)
  approverId      String?     @map("approver_id")
  approverRemarks String?     @map("approver_remarks")
  approvedAt      DateTime?   @map("approved_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  employee  Employee        @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveType LeaveTypeConfig @relation(fields: [leaveTypeId], references: [id])
  approver  User?           @relation("LeaveApprover", fields: [approverId], references: [id])

  @@index([employeeId])
  @@index([leaveTypeId])
  @@index([status])
  @@index([startDate])
  @@map("leave_requests")
}

model Payroll {
  id              String        @id @default(uuid())
  employeeId      String        @map("employee_id")
  month           Int
  year            Int
  baseSalary      Decimal       @map("base_salary") @db.Decimal(12, 2)
  grossSalary     Decimal       @map("gross_salary") @db.Decimal(12, 2)
  totalAllowances Decimal       @default(0) @map("total_allowances") @db.Decimal(12, 2)
  totalDeductions Decimal       @default(0) @map("total_deductions") @db.Decimal(12, 2)
  netSalary       Decimal       @map("net_salary") @db.Decimal(12, 2)
  status          PayrollStatus @default(DRAFT)
  processedAt     DateTime?     @map("processed_at")
  approvedById    String?       @map("approved_by_id")
  approvedAt      DateTime?     @map("approved_at")
  paidAt          DateTime?     @map("paid_at")
  notes           String?

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  employee   Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  approvedBy User?         @relation("PayrollApprover", fields: [approvedById], references: [id])
  items      PayrollItem[]

  @@unique([employeeId, month, year])
  @@index([employeeId])
  @@index([status])
  @@index([year, month])
  @@map("payrolls")
}

model PayrollItem {
  id              String              @id @default(uuid())
  payrollId       String              @map("payroll_id")
  name            String
  type            SalaryComponentType
  calculationType CalculationType     @map("calculation_type")
  value           Decimal             @db.Decimal(12, 2) // The base value or percentage
  amount          Decimal             @db.Decimal(12, 2) // Calculated amount

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  payroll Payroll @relation(fields: [payrollId], references: [id], onDelete: Cascade)

  @@index([payrollId])
  @@map("payroll_items")
}

model SalaryComponent {
  id              String              @id @default(uuid())
  name            String              @unique
  type            SalaryComponentType
  calculationType CalculationType     @map("calculation_type")
  defaultValue    Decimal             @map("default_value") @db.Decimal(12, 2)
  isActive        Boolean             @default(true) @map("is_active")
  appliesToAll    Boolean             @default(false) @map("applies_to_all")
  description     String?

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  employeeAssignments EmployeeSalaryComponent[]

  @@map("salary_components")
}

model EmployeeSalaryComponent {
  id          String   @id @default(uuid())
  employeeId  String   @map("employee_id")
  componentId String   @map("component_id")
  value       Decimal? @db.Decimal(12, 2) // Override value if different from default

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  employee  Employee        @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  component SalaryComponent @relation(fields: [componentId], references: [id], onDelete: Cascade)

  @@unique([employeeId, componentId])
  @@index([employeeId])
  @@map("employee_salary_components")
}

model EmployeeAttendance {
  id         String                   @id @default(uuid())
  employeeId String                   @map("employee_id")
  date       DateTime                 @db.Date
  checkIn    DateTime?                @map("check_in")
  checkOut   DateTime?                @map("check_out")
  status     EmployeeAttendanceStatus
  workHours  Decimal?                 @map("work_hours") @db.Decimal(4, 2)
  remarks    String?

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, date])
  @@index([employeeId])
  @@index([date])
  @@map("employee_attendances")
}

// ===========================================
// Finance Models
// ===========================================

model FeeStructure {
  id              String  @id @default(uuid())
  programId       String  @map("program_id")
  academicYear    String  @map("academic_year")
  tuitionFee      Decimal @map("tuition_fee") @db.Decimal(12, 2)
  registrationFee Decimal @map("registration_fee") @db.Decimal(12, 2)
  libraryFee      Decimal @map("library_fee") @db.Decimal(12, 2)
  labFee          Decimal @default(0) @map("lab_fee") @db.Decimal(12, 2)
  otherFees       Json?   @map("other_fees") // Flexible for additional fees

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  program Program @relation(fields: [programId], references: [id])

  @@unique([programId, academicYear])
  @@index([programId])
  @@map("fee_structures")
}

model Invoice {
  id          String        @id @default(uuid())
  invoiceNo   String        @unique @map("invoice_no") // Auto-generated
  studentId   String        @map("student_id")
  semesterId  String        @map("semester_id")
  amount      Decimal       @db.Decimal(12, 2)
  dueDate     DateTime      @map("due_date")
  status      InvoiceStatus @default(PENDING)
  description String?

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  student             Student              @relation(fields: [studentId], references: [id])
  payments            Payment[]
  paymentSessions     PaymentSession[]
  paymentTransactions PaymentTransaction[]
  paymentPlans        PaymentPlan[]

  @@index([studentId])
  @@index([status])
  @@index([dueDate])
  @@map("invoices")
}

model Payment {
  id           String        @id @default(uuid())
  receiptNo    String        @unique @map("receipt_no") // Auto-generated
  invoiceId    String?       @map("invoice_id")
  studentId    String        @map("student_id")
  amount       Decimal       @db.Decimal(12, 2)
  method       PaymentMethod
  reference    String? // Transaction reference
  receivedById String        @map("received_by_id")
  notes        String?

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  invoice        Invoice?             @relation(fields: [invoiceId], references: [id])
  student        Student              @relation(fields: [studentId], references: [id])
  transactions   PaymentTransaction[]
  refundRequests RefundRequest[]
  installments   Installment[]

  @@index([studentId])
  @@index([invoiceId])
  @@index([method])
  @@index([createdAt])
  @@map("payments")
}

model Scholarship {
  id                  String          @id @default(uuid())
  name                String
  description         String?
  type                ScholarshipType @default(MERIT)
  amount              Decimal         @db.Decimal(12, 2)
  amountType          String          @default("FIXED") @map("amount_type") // FIXED or PERCENTAGE
  criteria            Json? // {minGPA, maxIncome, programs[], yearOfStudy[]}
  maxRecipients       Int?            @map("max_recipients")
  academicYearId      String?         @map("academic_year_id")
  applicationDeadline DateTime?       @map("application_deadline")
  isActive            Boolean         @default(true) @map("is_active")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  academicYear AcademicYear?        @relation(fields: [academicYearId], references: [id])
  awards       StudentScholarship[]

  @@index([type])
  @@index([academicYearId])
  @@map("scholarships")
}

model StudentScholarship {
  id               String                 @id @default(uuid())
  studentId        String                 @map("student_id")
  scholarshipId    String                 @map("scholarship_id")
  amount           Decimal                @db.Decimal(12, 2)
  status           ScholarshipAwardStatus @default(PENDING)
  appliedToInvoice String?                @map("applied_to_invoice")
  awardedById      String                 @map("awarded_by_id")
  awardedAt        DateTime               @default(now()) @map("awarded_at")
  revokedAt        DateTime?              @map("revoked_at")
  revokedReason    String?                @map("revoked_reason")
  notes            String?

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  student     Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  scholarship Scholarship @relation(fields: [scholarshipId], references: [id])
  awardedBy   User        @relation("ScholarshipAwarder", fields: [awardedById], references: [id])

  @@unique([studentId, scholarshipId])
  @@index([status])
  @@map("student_scholarships")
}

model FeeWaiver {
  id               String          @id @default(uuid())
  studentId        String          @map("student_id")
  type             WaiverType
  amount           Decimal         @db.Decimal(12, 2)
  amountType       String          @default("FIXED") @map("amount_type") // FIXED or PERCENTAGE
  reason           String
  supportingDocs   Json?           @map("supporting_docs") // Array of file paths/URLs
  status           FeeWaiverStatus @default(PENDING)
  approvedById     String?         @map("approved_by_id")
  rejectionReason  String?         @map("rejection_reason")
  validFrom        DateTime        @map("valid_from")
  validTo          DateTime        @map("valid_to")
  appliedToInvoice String?         @map("applied_to_invoice")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  student    Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  approvedBy User?   @relation("WaiverApprover", fields: [approvedById], references: [id])

  @@index([studentId])
  @@index([status])
  @@map("fee_waivers")
}

model PaymentPlan {
  id                   String            @id @default(uuid())
  studentId            String            @map("student_id")
  invoiceId            String            @map("invoice_id")
  totalAmount          Decimal           @map("total_amount") @db.Decimal(12, 2)
  downPayment          Decimal           @map("down_payment") @db.Decimal(12, 2)
  numberOfInstallments Int               @map("number_of_installments")
  startDate            DateTime          @map("start_date")
  status               PaymentPlanStatus @default(ACTIVE)
  lateFeePercentage    Decimal           @default(2) @map("late_fee_percentage") @db.Decimal(5, 2)
  createdById          String            @map("created_by_id")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  student      Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  invoice      Invoice       @relation(fields: [invoiceId], references: [id])
  createdBy    User          @relation("PaymentPlanCreator", fields: [createdById], references: [id])
  installments Installment[]

  @@index([studentId])
  @@index([invoiceId])
  @@index([status])
  @@map("payment_plans")
}

model Installment {
  id         String            @id @default(uuid())
  planId     String            @map("plan_id")
  number     Int
  amount     Decimal           @db.Decimal(12, 2)
  dueDate    DateTime          @map("due_date")
  paidAmount Decimal           @default(0) @map("paid_amount") @db.Decimal(12, 2)
  status     InstallmentStatus @default(PENDING)
  lateFee    Decimal           @default(0) @map("late_fee") @db.Decimal(12, 2)
  paidAt     DateTime?         @map("paid_at")
  paymentId  String?           @map("payment_id")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  plan    PaymentPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  payment Payment?    @relation(fields: [paymentId], references: [id])

  @@index([planId])
  @@index([dueDate])
  @@index([status])
  @@map("installments")
}

model RefundRequest {
  id              String       @id @default(uuid())
  studentId       String       @map("student_id")
  paymentId       String       @map("payment_id")
  amount          Decimal      @db.Decimal(12, 2)
  reason          RefundReason
  description     String?
  status          RefundStatus @default(PENDING)
  approvedById    String?      @map("approved_by_id")
  processedById   String?      @map("processed_by_id")
  refundMethod    String?      @map("refund_method")
  refundReference String?      @map("refund_reference")
  rejectionReason String?      @map("rejection_reason")
  approvedAt      DateTime?    @map("approved_at")
  processedAt     DateTime?    @map("processed_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  student     Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  payment     Payment @relation(fields: [paymentId], references: [id])
  approvedBy  User?   @relation("RefundApprover", fields: [approvedById], references: [id])
  processedBy User?   @relation("RefundProcessor", fields: [processedById], references: [id])

  @@index([studentId])
  @@index([paymentId])
  @@index([status])
  @@map("refund_requests")
}

model Vendor {
  id       String  @id @default(uuid())
  name     String
  email    String?
  phone    String?
  address  String?
  taxId    String? @map("tax_id")
  isActive Boolean @default(true) @map("is_active")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  expenses Expense[]

  @@map("vendors")
}

model Expense {
  id           String   @id @default(uuid())
  vendorId     String?  @map("vendor_id")
  categoryId   String?  @map("category_id")
  amount       Decimal  @db.Decimal(12, 2)
  description  String
  date         DateTime
  reference    String? // Invoice/receipt number
  approvedById String?  @map("approved_by_id")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  vendor   Vendor?          @relation(fields: [vendorId], references: [id])
  category ExpenseCategory? @relation(fields: [categoryId], references: [id])

  @@index([vendorId])
  @@index([date])
  @@map("expenses")
}

model ExpenseCategory {
  id          String  @id @default(uuid())
  name        String  @unique
  description String?

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  expenses Expense[]

  @@map("expense_categories")
}

model Budget {
  id           String       @id @default(uuid())
  name         String
  departmentId String?      @map("department_id")
  fiscalYear   String       @map("fiscal_year")
  totalAmount  Decimal      @map("total_amount") @db.Decimal(12, 2)
  status       BudgetStatus @default(DRAFT)
  notes        String?

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  department Department?      @relation(fields: [departmentId], references: [id])
  categories BudgetCategory[]

  @@unique([departmentId, fiscalYear])
  @@index([fiscalYear])
  @@index([status])
  @@map("budgets")
}

model BudgetCategory {
  id              String  @id @default(uuid())
  budgetId        String  @map("budget_id")
  name            String
  allocatedAmount Decimal @map("allocated_amount") @db.Decimal(12, 2)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  budget   Budget          @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  expenses BudgetExpense[]

  @@index([budgetId])
  @@map("budget_categories")
}

model BudgetExpense {
  id           String   @id @default(uuid())
  categoryId   String   @map("category_id")
  amount       Decimal  @db.Decimal(12, 2)
  description  String
  date         DateTime @default(now())
  reference    String?
  recordedById String   @map("recorded_by_id")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  category   BudgetCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  recordedBy User           @relation("BudgetExpenseRecorder", fields: [recordedById], references: [id])

  @@index([categoryId])
  @@index([date])
  @@map("budget_expenses")
}

// ===========================================
// Library Models
// ===========================================

model BookCategory {
  id          String  @id @default(uuid())
  name        String  @unique
  nameLocal   String? @map("name_local")
  code        String  @unique // e.g., "CS", "BUS", "MED"
  parentId    String? @map("parent_id")
  description String?

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  parent   BookCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children BookCategory[] @relation("CategoryHierarchy")
  books    Book[]

  @@index([parentId])
  @@map("book_categories")
}

model LibraryLocation {
  id       String  @id @default(uuid())
  name     String  @unique // e.g., "Main Library", "CS Reading Room"
  building String?
  floor    String?
  section  String? // e.g., "A1", "B2"
  capacity Int? // Shelf capacity
  isActive Boolean @default(true) @map("is_active")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  books Book[]

  @@map("library_locations")
}

model Book {
  id              String     @id @default(uuid())
  isbn            String?    @unique
  title           String
  titleLocal      String?    @map("title_local")
  author          String
  coAuthors       String[]   @map("co_authors")
  publisher       String?
  publishYear     Int?       @map("publish_year")
  edition         String?
  language        String     @default("English")
  pages           Int?
  categoryId      String     @map("category_id")
  locationId      String?    @map("location_id")
  shelfNumber     String?    @map("shelf_number")
  totalCopies     Int        @default(1) @map("total_copies")
  availableCopies Int        @default(1) @map("available_copies")
  coverImage      String?    @map("cover_image")
  description     String?
  tags            String[]
  status          BookStatus @default(AVAILABLE)

  // Soft delete
  deletedAt DateTime? @map("deleted_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  category     BookCategory     @relation(fields: [categoryId], references: [id])
  location     LibraryLocation? @relation(fields: [locationId], references: [id])
  copies       BookCopy[]
  reservations Reservation[]

  @@index([categoryId])
  @@index([locationId])
  @@index([title])
  @@index([author])
  @@index([status])
  @@map("books")
}

model BookCopy {
  id              String        @id @default(uuid())
  bookId          String        @map("book_id")
  copyNumber      String        @map("copy_number") // e.g., "001", "002"
  barcode         String        @unique
  condition       CopyCondition @default(GOOD)
  status          CopyStatus    @default(AVAILABLE)
  acquisitionDate DateTime      @default(now()) @map("acquisition_date")
  acquisitionType String        @default("PURCHASE") @map("acquisition_type") // PURCHASE, DONATION, TRANSFER
  notes           String?

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  book       Book        @relation(fields: [bookId], references: [id])
  borrowings Borrowing[]

  @@unique([bookId, copyNumber])
  @@index([bookId])
  @@index([status])
  @@map("book_copies")
}

model Borrowing {
  id            String          @id @default(uuid())
  bookCopyId    String          @map("book_copy_id")
  borrowerId    String          @map("borrower_id")
  borrowerType  String          @map("borrower_type") // STUDENT or EMPLOYEE
  borrowDate    DateTime        @default(now()) @map("borrow_date")
  dueDate       DateTime        @map("due_date")
  returnDate    DateTime?       @map("return_date")
  renewCount    Int             @default(0) @map("renew_count")
  status        BorrowingStatus @default(ACTIVE)
  lateFee       Decimal?        @map("late_fee") @db.Decimal(10, 2)
  lateFeeStatus LateFeeStatus?  @map("late_fee_status")
  issuedById    String          @map("issued_by_id")
  returnedToId  String?         @map("returned_to_id")
  waivedById    String?         @map("waived_by_id")
  waiveReason   String?         @map("waive_reason")
  notes         String?

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  bookCopy   BookCopy @relation(fields: [bookCopyId], references: [id])
  borrower   User     @relation("BorrowingBorrower", fields: [borrowerId], references: [id])
  issuedBy   User     @relation("BorrowingIssuer", fields: [issuedById], references: [id])
  returnedTo User?    @relation("BorrowingReceiver", fields: [returnedToId], references: [id])
  waivedBy   User?    @relation("BorrowingWaiver", fields: [waivedById], references: [id])

  @@index([bookCopyId])
  @@index([borrowerId])
  @@index([status])
  @@index([dueDate])
  @@map("borrowings")
}

model Reservation {
  id          String            @id @default(uuid())
  bookId      String            @map("book_id")
  userId      String            @map("user_id")
  reservedAt  DateTime          @default(now()) @map("reserved_at")
  expiresAt   DateTime          @map("expires_at")
  status      ReservationStatus @default(PENDING)
  notifiedAt  DateTime?         @map("notified_at")
  fulfilledAt DateTime?         @map("fulfilled_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  book Book @relation(fields: [bookId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@index([bookId, status])
  @@index([userId])
  @@map("reservations")
}

model LibraryCard {
  id         String   @id @default(uuid())
  userId     String   @unique @map("user_id")
  cardNumber String   @unique @map("card_number")
  memberType String   @map("member_type") // STUDENT or EMPLOYEE
  issuedAt   DateTime @default(now()) @map("issued_at")
  expiresAt  DateTime @map("expires_at")
  isActive   Boolean  @default(true) @map("is_active")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@map("library_cards")
}

// ===========================================
// System Models
// ===========================================

model SystemConfig {
  id          String  @id @default(uuid())
  key         String  @unique
  value       Json
  description String?

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_configs")
}

model Announcement {
  id           String           @id @default(uuid())
  title        String
  titleLocal   String?          @map("title_local")
  content      String
  contentLocal String?          @map("content_local")
  type         AnnouncementType
  targetRoles  String[]         @map("target_roles") // Which roles can see this
  publishAt    DateTime         @map("publish_at")
  expiresAt    DateTime?        @map("expires_at")
  isActive     Boolean          @default(true) @map("is_active")
  createdById  String           @map("created_by_id")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([type])
  @@index([isActive])
  @@index([publishAt])
  @@map("announcements")
}

// ===========================================
// Email & Notification Models
// ===========================================

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  ACADEMIC
  FINANCE
  LIBRARY
  HR
  SYSTEM
}

enum EmailStatus {
  PENDING
  PROCESSING
  SENT
  FAILED
  BOUNCED
}

model EmailTemplate {
  id            String   @id @default(uuid())
  name          String   @unique
  subject       String
  subjectLocal  String?  @map("subject_local")
  bodyHtml      String   @map("body_html") @db.Text
  bodyText      String   @map("body_text") @db.Text
  bodyHtmlLocal String?  @map("body_html_local") @db.Text
  bodyTextLocal String?  @map("body_text_local") @db.Text
  variables     String[]
  category      String? // auth, admission, academic, finance, hr, library, general
  isActive      Boolean  @default(true) @map("is_active")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([category])
  @@index([isActive])
  @@map("email_templates")
}

model EmailLog {
  id          String      @id @default(uuid())
  to          String[]
  cc          String[]
  bcc         String[]
  subject     String
  template    String?
  bodyHtml    String?     @map("body_html") @db.Text
  status      EmailStatus @default(PENDING)
  error       String?
  attempts    Int         @default(0)
  sentAt      DateTime?   @map("sent_at")
  scheduledAt DateTime?   @map("scheduled_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  @@index([status])
  @@index([template])
  @@index([createdAt])
  @@map("email_logs")
}

model Notification {
  id      String           @id @default(uuid())
  userId  String           @map("user_id")
  type    NotificationType
  title   String
  message String
  data    Json?
  link    String?
  isRead  Boolean          @default(false) @map("is_read")
  readAt  DateTime?        @map("read_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

model ScheduledEmail {
  id          String      @id @default(uuid())
  options     Json // EmailOptions serialized
  scheduledAt DateTime    @map("scheduled_at")
  status      EmailStatus @default(PENDING)
  processedAt DateTime?   @map("processed_at")
  error       String?

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  @@index([scheduledAt, status])
  @@map("scheduled_emails")
}

// ===========================================
// SMS Models
// ===========================================

model SMSLog {
  id          String    @id @default(uuid())
  to          String // Phone number with country code
  message     String    @db.Text
  template    String? // Template name used
  status      SMSStatus @default(PENDING)
  messageId   String?   @map("message_id") // Provider message ID
  provider    String? // SMS provider used
  error       String?
  cost        Decimal?  @db.Decimal(10, 4)
  sentAt      DateTime? @map("sent_at")
  deliveredAt DateTime? @map("delivered_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  @@index([to])
  @@index([status])
  @@index([createdAt])
  @@map("sms_logs")
}

model OTPCode {
  id        String     @id @default(uuid())
  phone     String
  code      String
  purpose   OTPPurpose
  expiresAt DateTime   @map("expires_at")
  verified  Boolean    @default(false)
  attempts  Int        @default(0)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  @@index([phone, purpose])
  @@index([expiresAt])
  @@map("otp_codes")
}

// ===========================================
// Payment Gateway Models
// ===========================================

model PaymentSession {
  id          String                   @id @default(uuid())
  studentId   String                   @map("student_id")
  invoiceId   String?                  @map("invoice_id")
  amount      Decimal                  @db.Decimal(12, 2)
  currency    String                   @default("USD")
  status      PaymentTransactionStatus @default(PENDING)
  expiresAt   DateTime                 @map("expires_at")
  completedAt DateTime?                @map("completed_at")

  // Relations
  student      Student              @relation(fields: [studentId], references: [id])
  invoice      Invoice?             @relation(fields: [invoiceId], references: [id])
  transactions PaymentTransaction[]

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([studentId])
  @@index([status])
  @@index([expiresAt])
  @@map("payment_sessions")
}

model PaymentTransaction {
  id            String                   @id @default(uuid())
  sessionId     String?                  @map("session_id")
  studentId     String?                  @map("student_id")
  invoiceId     String?                  @map("invoice_id")
  paymentId     String?                  @map("payment_id") // Link to Payment record
  amount        Decimal                  @db.Decimal(12, 2)
  currency      String                   @default("USD")
  method        PaymentMethod
  provider      String // EVC_PLUS, ZAAD, SAHAL, BANK, etc.
  providerTxnId String?                  @map("provider_txn_id") // Provider's transaction ID
  status        PaymentTransactionStatus @default(PENDING)
  phone         String? // For mobile money payments
  metadata      Json?
  errorMessage  String?                  @map("error_message")
  initiatedAt   DateTime                 @default(now()) @map("initiated_at")
  completedAt   DateTime?                @map("completed_at")

  // Relations
  session PaymentSession? @relation(fields: [sessionId], references: [id])
  student Student?        @relation(fields: [studentId], references: [id])
  invoice Invoice?        @relation(fields: [invoiceId], references: [id])
  payment Payment?        @relation(fields: [paymentId], references: [id])

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([sessionId])
  @@index([studentId])
  @@index([invoiceId])
  @@index([status])
  @@index([providerTxnId])
  @@map("payment_transactions")
}
